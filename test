using Microsoft.Win32.SafeHandles;
using System.Runtime.InteropServices;

namespace eServices.APIs.UserApp.Application.Helpers
{
    public class UserImpersonation : IDisposable
    {
        private IntPtr userHandle = IntPtr.Zero;
        private SafeAccessTokenHandle _handle;

        public SafeAccessTokenHandle SafeAccessTokenHandle => _handle;

        public UserImpersonation(string domain, string username, string password)
        {
            bool success = LogonUser(username, domain, password, LogonType.Interactive, LogonProvider.Default, out userHandle);
            if (!success)
            {
                int error = Marshal.GetLastWin32Error();
                throw new System.ComponentModel.Win32Exception(error);
            }

            _handle = new SafeAccessTokenHandle(userHandle);
        }

        public void Dispose()
        {
            _handle?.Dispose();
        }

        [DllImport("advapi32.dll", SetLastError = true, CharSet = CharSet.Unicode)]
        private static extern bool LogonUser(string lpszUsername, string lpszDomain, string lpszPassword,
            LogonType dwLogonType, LogonProvider dwLogonProvider, out IntPtr phToken);

        private enum LogonType : int
        {
            Interactive = 2,
            Network = 3,
            Batch = 4,
            Service = 5,
            Unlock = 7,
            NetworkClearText = 8,
            NewCredentials = 9
        }

        private enum LogonProvider : int
        {
            Default = 0,
            WinNT35 = 1,
            WinNT40 = 2,
            WinNT50 = 3
        }
    }
}
